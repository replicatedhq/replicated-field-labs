#!/usr/bin/env bash

# download and use our shared library with auto-download functionality
curl -s -o /etc/profile.d/header.sh https://raw.githubusercontent.com/replicatedhq/replicated-field-labs/refactor/crdant/builds-comprehensive-library/libs/header.sh
source /etc/profile.d/header.sh

# Initialize setup script with proper error handling
init_setup_script

# Setup common environment variables
setup_common_environment

cat <<EMPTY_PREFLIGHT_SECRET > /home/replicant/empty-preflight-secret.yaml
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: empty-preflights
  labels:
    troubleshoot.sh/kind: preflight
stringData:
  preflight.yaml: |- 
    apiVersion: troubleshoot.sh/v1beta2
    kind: Preflight
    metadata:
      name: empty-preflight-checks
    spec:
      analyzers: []
EMPTY_PREFLIGHT_SECRET
chown replicant /home/replicant/empty-preflight-secret.yaml

agent variable set USERNAME $(get_username)
agent variable set PASSWORD $(get_password)
agent variable set REPLICATED_API_TOKEN ${REPLICATED_API_TOKEN}
agent variable set REPLICATED_APP ${REPLICATED_APP}


