#!/bin/bash
#
# This script runs when the platform check the challenge.
#
# The platform determines if the script was successful using the exit code of this
# script. If the exit code is not 0, the script fails.
#

URL=$(agent variable get CLUSTER_URL)
app=$(kubectl get deployments -o json -A | jq -r '.items[].metadata | .labels | ."kots.io/app-slug" | select( . != null )' | head -n 1)

if ! curl -LkSs "${URL}:8800"; then
  fail-message "The Admin Console is not available. please ensure you deployed the embedded cluster with KOTS."
  exit 1
fi

if [ ! -d /root/.kube ]; then
  # generate and fetch kubeconfig for cluster
  mkdir /root/.kube
  ssh kurl-node-1 "curl https://kurl.sh/latest/tasks.sh | SUDO_USER=root bash -s generate-admin-user"
  scp kurl-node-1:root.conf /root/.kube/config
fi



if [[ $(kubectl get deployments -A --no-headers -l kots.io/app-slug="${app}"  | awk '{print $2}' | xargs shuf -n1 -e) = "" ]]; then
  fail-message "No deployments found for app-slug ${app}. Please ensure that you've uploaded your license and the application is successfully deployed."
  exit 1
fi

agent variable set APP_SLUG "${app}"
