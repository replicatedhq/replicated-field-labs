#!/usr/bin/env bash

# download and use our shared library with auto-download functionality
curl -s -o /etc/profile.d/header.sh https://raw.githubusercontent.com/replicatedhq/replicated-field-labs/refactor/crdant/builds-comprehensive-library/libs/header.sh
source /etc/profile.d/header.sh

# Initialize setup script with proper error handling
init_setup_script true

### Setup tmux session for Instruqt challenge
#
# In a test scenario Instruqt does not run the user shell for the
# challenge, which means the tmux session is never established. We
# need the session for solve scripts in other challenges to 
# succeed, so let's create it here.
#

ensure_tmux_session "shell" "replicant"

# Update the chart version
yq -i '.version = "0.2.0"' ${HOME_DIR}/slackernews/Chart.yaml

# Add the SDK dependency
yq -i '.dependencies = []' ${HOME_DIR}/slackernews/Chart.yaml
yq -i ".dependencies += { \"name\": \"replicated\", \"repository\": \"oci://registry.replicated.com/library\", \"version\": \"$(get_replicated_sdk_version)\"}" ${HOME_DIR}/slackernews/Chart.yaml

# Re-package the chart
helm package --dependency-update ${HOME_DIR}/slackernews --destination ${HOME_DIR}/release

# Ensure proper permissions
chown -R replicant:replicant ${HOME_DIR}/slackernews ${HOME_DIR}/release
