#!/usr/bin/env bash

# use our shared library with auto-download functionality
curl -s -o /etc/profile.d/header.sh https://raw.githubusercontent.com/replicatedhq/replicated-field-labs/refactor/crdant/builds-comprehensive-library/libs/header.sh
source /etc/profile.d/header.sh

# Initialize setup script with proper error handling
init_setup_script true

# Setup SSH client configuration for connecting to shell
setup_ssh_config

# Wait for SSH connectivity to shell
wait_for_ssh_connectivity "shell" 60

# Create kube directory on shell
ssh shell "mkdir -p /home/replicant/.kube"

# Wait for Kubernetes API server to be available
wait_for_http_endpoint "http://localhost:8001/api" 200 120

# Wait for Kubernetes configuration to be available
wait_for_kubeconfig "/etc/rancher/k3s/k3s.yaml" 120

# Copy Kubernetes configuration to shell
scp /etc/rancher/k3s/k3s.yaml shell:/home/replicant/.kube/config
