#!/usr/bin/env bash

# download and use our shared library with auto-download functionality
curl -s -o /etc/profile.d/header.sh https://raw.githubusercontent.com/replicatedhq/replicated-field-labs/refactor/crdant/builds-comprehensive-library/libs/header.sh
source /etc/profile.d/header.sh

# Initialize setup script with proper error handling
init_setup_script true

# get the application slug for the chart URL
api_token=$(get_api_token)
app_slug=$(curl --header 'Accept: application/json' --header "Authorization: ${api_token}" https://api.replicated.com/vendor/v3/apps | jq -r '.apps[0].slug')

# login to the registry using cached functions
customer_email=$(get_customer_email)
registry_password=$(get_registry_password)
echo "${registry_password}" | helm registry login registry.replicated.com \
  --username "${customer_email}" \
  --password-stdin

# install the application
helm install --namespace slackernews --create-namespace slackernews \
  oci://registry.replicated.com/${app_slug}/slackernews \
  --set slackernews.domain=$(get_slackernews_domain) \
  --set service.type=NodePort \
  --kubeconfig /home/replicant/.kube/config